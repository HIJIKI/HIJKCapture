//--------------------------------------------------------------------------------------------------
//= SubRoutine.hsp
//--------------------------------------------------------------------------------------------------
//	サブルーチン
//--------------------------------------------------------------------------------------------------

	//----------------------------------------------------------------------------------------------
	//= 終了処理
	//----------------------------------------------------------------------------------------------
		*__end
			end

	//----------------------------------------------------------------------------------------------
	//= 範囲選択ループから編集ループへ移る際の引継ぎ処理
	//----------------------------------------------------------------------------------------------
		*__SelectToEdit
			//キャプチャサイズが0x0にならないために修正
			if( CaptureSizeW < 1 ){ CaptureSizeW = 1 }
			if( CaptureSizeH < 1 ){ CaptureSizeH = 1 }
			//スクリーンショット撮影
			buffer SCR_SSBUF, CaptureSizeW, CaptureSizeH
			GetScreenShot CapturePosX, CapturePosY, CaptureSizeW, CaptureSizeH, 0
			//ペンバッファ初期化
			buffer SCR_PENBUF, CaptureSizeW, CaptureSizeH
			COLSET_ALPHA:boxf
			//編集ウィンドウを表示
			gsel SCR_EDIT, 1
			//編集画面用変数を初期化
			EditPenSize = 5
			EditColor = 0
			if( CaptureSizeW < EDITWINDOW_SIZE_W ){
				EditPosX = ginfo_winx/2-CaptureSizeW/2
			} else {
				EditPosX = 64
			}
			if( CaptureSizeH < EDITWINDOW_SIZE_H ){
				EditPosY = ginfo_winy/2-CaptureSizeH/2
			} else {
				EditPosY = 64
			}
			//パレットボタン設置
			syscolor 4	: bg = ginfo_r, ginfo_g, ginfo_b
			margin = 2
			w = PALETTEBAR_SIZE_H-margin*2	: h = w
			x = PALETTEBAR_POS_X+margin		: y = PALETTEBAR_POS_Y+margin
			foreach EditPaletteTable
				c = RefToR(EditPaletteTable(cnt)), RefToG(EditPaletteTable(cnt)), RefToB(EditPaletteTable(cnt))
				mgButtonColor bg, c, c, c
				mgButton "■", *__PaletteButton, x+(w+margin)*cnt, y, w, h, 1
				PaletteButtonID(cnt) = stat
			loop
			//全消しボタン設置
			x = (PALETTEBAR_POS_X+margin)+(PALETTEBAR_SIZE_H-margin)*length(EditPaletteTable)
			y = PALETTEBAR_POS_Y+margin
			w = PALETTEBAR_SIZE_H-margin*2	: h = w
			mgButtonColor bg, bg, bg, bg
			mgButton "", *__ClearButton, x, y, w, h, 1, SCR_BUTTONICON, 0
		return

	//----------------------------------------------------------------------------------------------
	//= パレットボタン
	//----------------------------------------------------------------------------------------------
		*__PaletteButton
			foreach PaletteButtonID
				if( PaletteButtonID(cnt) == stat ){
					id = cnt
					break
				}
			loop
			EditPenColor = EditPaletteTable(id)
		return

	//----------------------------------------------------------------------------------------------
	//= 全消しボタン
	//----------------------------------------------------------------------------------------------
		*__ClearButton
			gsel SCR_PENBUF
			COLSET_ALPHA
			boxf
			gsel SCR_EDIT
		return

	//----------------------------------------------------------------------------------------------
	//= 保存画像バッファ作成
	//----------------------------------------------------------------------------------------------
		*__MakeSaveBuffer
			buffer SCR_SAVEBUF, CaptureSizeW, CaptureSizeH
			gmode 0
			pos 0, 0
			gcopy SCR_SSBUF, 0, 0, CaptureSizeW, CaptureSizeH
			COLSET_ALPHA
			gmode 4, , , 256
			pos 0, 0
			gcopy SCR_PENBUF, 0, 0, CaptureSizeW, CaptureSizeH
		return

	//----------------------------------------------------------------------------------------------
	//= アップロードボタン
	//----------------------------------------------------------------------------------------------
		*__Upload
		return

	//----------------------------------------------------------------------------------------------
	//= ローカルへ保存ボタン
	//----------------------------------------------------------------------------------------------
		*__LocalSave
			dialog "png",17,"PNG"
			if( stat == 1 ){
				savepath = ""+getpath(refstr, 1)+".png"
				gosub *__MakeSaveBuffer
				pngsave ""+savepath
				goto *__end
			}
		return

	//----------------------------------------------------------------------------------------------
	//= キャンセルボタン
	//----------------------------------------------------------------------------------------------
		*__Cancel
			goto *__end
		return

	//----------------------------------------------------------------------------------------------
	//= マウスが編集画面有効範囲内にあるかを判別
	//----------------------------------------------------------------------------------------------
		#defcfunc MouseEditRange
			ret = 0
			if( MousePosX() >= 0 ){
				if( MousePosX() <= EDITWINDOW_SIZE_W ){
					if( MousePosY() >= 0+PALETTEBAR_SIZE_H ){
						if( MousePosY() <= EDITWINDOW_SIZE_H-CTRLBAR_SIZE_H ){
							ret = 1
						}
					}
				}
			}
		return ret